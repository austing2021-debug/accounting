<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記帳本 (Supabase + Cloudflare)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center p-4">

    <div class="w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden">
        <div class="bg-blue-600 p-4">
            <h1 class="text-white text-xl font-bold text-center">日常記帳 (Cloud Version)</h1>
        </div>

        <div class="p-6 space-y-4">
            <form id="accountForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">主分類</label>
                        <select id="mainCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-gray-50" required>
                            <option value="" disabled selected>請選擇</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">子分類</label>
                        <select id="subCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-gray-50" required>
                            <option value="">請先選主分類</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">金額 ($)</label>
                    <input type="number" id="amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="輸入金額" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">備註 (選填)</label>
                    <input type="text" id="note" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="例如：巷口麵攤">
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200 font-bold">
                    新增紀錄
                </button>
            </form>

            <hr class="border-gray-200">

            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">最近 5 筆紀錄</h3>
                <ul id="historyList" class="divide-y divide-gray-200 bg-gray-50 rounded-md p-2 text-sm">
                    <li class="py-2 text-center text-gray-500">載入中...</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. 設定區：請務必填入你的 Supabase URL 和 Anon Key
        // ==========================================
        const SUPABASE_URL = 'https://sprrurptghjkxvwstukn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcnJ1cnB0Z2hqa3h2d3N0dWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjcyOTMsImV4cCI6MjA4NDU0MzI5M30.IoOY-gdM7qXPEm3DildpEOq_e3jpTfQLa19X7G6iImw';

        // 檢查是否忘記填寫金鑰
        if (SUPABASE_URL.includes('你的') || SUPABASE_KEY.includes('你的')) {
            alert('錯誤：請在程式碼第 70 行填入正確的 Supabase URL 和 API Key，否則無法連線！');
            document.getElementById('historyList').innerHTML = '<li class="py-2 text-center text-red-500">未設定 API Key</li>';
            throw new Error("API Key missing");
        }
        
        // 修正點：使用解構賦值，避免變數名稱衝突
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==========================================
        // 2. 資料結構
        // ==========================================
        const subData = {
            "食": ["早餐", "中餐", "晚餐", "點心", "菜錢"],
            "衣": ["上衣", "褲子", "內衣", "內褲", "襪子", "配件"],
            "住": ["手機費", "網路費", "電費", "水費", "瓦斯費", "租車位費", "管理費", "稅費"],
            "行": ["油錢", "停車費", "住宿費", "租車費", "交通費", "修車費"],
            "育": ["學費", "書費", "教育費", "AI費"],
            "樂": ["娛樂費", "電視費"],
            "金": ["存款", "股票", "虛擬幣"],
            "雜": ["保險費", "其他"]
        };

        const mainSelect = document.getElementById('mainCategory');
        const subSelect = document.getElementById('subCategory');
        const form = document.getElementById('accountForm');
        const historyList = document.getElementById('historyList');
        const submitBtn = document.getElementById('submitBtn');

        // ==========================================
        // 3. 程式邏輯
        // ==========================================

        function initDropdowns() {
            Object.keys(subData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                mainSelect.appendChild(option);
            });
        }

        mainSelect.addEventListener('change', (e) => {
            const selectedMain = e.target.value;
            const subs = subData[selectedMain] || [];
            subSelect.innerHTML = '';
            subs.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subSelect.appendChild(option);
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = "傳送中...";
            submitBtn.disabled = true;

            const newData = {
                category: mainSelect.value,
                subcategory: subSelect.value,
                amount: parseFloat(document.getElementById('amount').value),
                note: document.getElementById('note').value
            };

            try {
                // 使用修正後的 supabaseClient
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .insert([newData]);

                if (error) throw error;

                alert('記帳成功！');
                form.reset();
                subSelect.innerHTML = '<option value="">請先選主分類</option>';
                fetchData();

            } catch (error) {
                console.error('Error:', error);
                alert('上傳失敗：' + error.message);
            } finally {
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        async function fetchData() {
            try {
                // 使用修正後的 supabaseClient
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                renderList(data);
            } catch (error) {
                console.error('Error fetching:', error);
                historyList.innerHTML = '<li class="py-2 text-center text-red-500">讀取失敗 (請檢查 Console)</li>';
            }
        }

        function renderList(data) {
            historyList.innerHTML = '';
            if (!data || data.length === 0) {
                historyList.innerHTML = '<li class="py-2 text-center text-gray-400">目前沒有紀錄</li>';
                return;
            }

            data.forEach(item => {
                const li = document.createElement('li');
                li.className = "py-3 flex justify-between items-center";
                const date = new Date(item.created_at).toLocaleDateString('zh-TW');
                
                li.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">${item.category}</span>
                            ${item.subcategory}
                        </div>
                        <div class="text-xs text-gray-500">${date} ${item.note ? '- ' + item.note : ''}</div>
                    </div>
                    <div class="font-bold text-green-600">$${item.amount}</div>
                `;
                historyList.appendChild(li);
            });
        }

        initDropdowns();
        fetchData(); // 啟動讀取
    </script>
</body>
</html>
