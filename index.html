<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦ ç†è²¡ç´€éŒ„ (Pro Version)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            /* 1. èƒŒæ™¯é¡è‰²æ”¹ç‚º #fbf9f4 */
            --bg-color: #fbf9f4;
            
            /* 4. å¡«å¯«è³‡æ–™è¡¨æ ¼èƒŒæ™¯è‰² */
            --input-bg: #f6f5ea;
            
            --card-bg: #ffffff;
            
            /* 2. åœ–æ¨™é¡è‰² */
            --icon-color: #454545;
            
            /* 3. å­—é«”åŸºæœ¬é¡è‰² #000000 */
            --text-main: #000000;
            --text-sub: #8d8d8d;
            
            /* 5. ä¸»é¡åˆ¥æŒ‰éˆ•é¡è‰² */
            --cat-default-bg: #f7f2f8;
            --cat-default-text: #454545;
            --cat-active-bg: #d8c1ec;
            --cat-active-text: #fbf9f4;

            /* 6. ç¢ºèªé€å‡ºæŒ‰éˆ•é¡è‰² */
            --btn-submit-bg: #d8c1ec;
            --btn-submit-text: #fbf9f4;
            --btn-submit-active-bg: #f7f2f8;
            --btn-submit-active-text: #454545;

            /* 7. é ç®—æŒ‰éˆ•é¡è‰² */
            --btn-budget-bg: #66b8db;
            --btn-budget-text: #fbf9f4;
            --btn-budget-active-bg: #9bd9f3;
            --btn-budget-active-text: #454545;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; 
        }

        header { padding: 15px; text-align: center; background: var(--bg-color); }
        h2 { margin: 0; color: var(--icon-color); font-size: 1.3rem; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .main-container { flex: 1; padding: 15px; padding-bottom: 80px; display: flex; justify-content: center; overflow-y: auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); width: 100%; max-width: 400px; box-sizing: border-box; min-height: fit-content; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-group { margin-bottom: 15px; }
        label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--icon-color); font-size: 14px; font-weight: bold; }
        label i { color: var(--icon-color); }

        /* 4. è¼¸å…¥æ¡†æ”¹ç‚ºå‡¹é™·ç‹€æ…‹ */
        input, select { 
            width: 100%; padding: 14px; 
            border: none;
            border-radius: 12px; 
            box-sizing: border-box; font-size: 16px; 
            background: var(--input-bg); 
            color: var(--text-main); 
            outline: none; -webkit-appearance: none;
            /* å…§é™°å½±å‰µé€ å‡¹é™·æ„Ÿ */
            box-shadow: inset 2px 2px 6px rgba(0,0,0,0.1), inset -2px -2px 6px rgba(255,255,255,0.7);
            transition: all 0.2s;
        }
        input:focus, select:focus {
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15);
        }

        /* 5. ä¸»é¡åˆ¥æŒ‰éˆ• - æ‡¸æµ®ç‹€æ…‹ */
        .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cat-btn { 
            padding: 12px 0; 
            background: var(--cat-default-bg); 
            color: var(--cat-default-text);
            border: none; 
            border-radius: 15px; 
            font-size: 14px; 
            font-weight: bold;
            cursor: pointer; 
            text-align: center; 
            /* æ‡¸æµ®é™°å½± */
            box-shadow: 3px 3px 6px rgba(0,0,0,0.1), -1px -1px 4px rgba(255,255,255,0.8);
            transition: all 0.2s ease;
        }
        /* é»æ“Šæ•ˆæœ */
        .cat-btn:active { transform: scale(0.96); }
        .cat-btn.active { 
            background: var(--cat-active-bg); 
            color: var(--cat-active-text); 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); /* æŒ‰ä¸‹è®Šæˆå‡¹é™· */
        }

        #sub-category-container { display: none; background: transparent; margin-bottom: 15px; }

        /* 6. ç¢ºèªé€å‡ºæŒ‰éˆ• - æ‡¸æµ®ç‹€æ…‹ */
        button.main-btn { 
            width: 100%; padding: 16px; 
            background: var(--btn-submit-bg); 
            color: var(--btn-submit-text); 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(216, 193, 236, 0.4);
            transition: all 0.2s;
        }
        button.main-btn:active {
            background: var(--btn-submit-active-bg);
            color: var(--btn-submit-active-text);
            transform: translateY(2px);
            box-shadow: none;
        }

        /* 7. é ç®—é‡‘é¡ç¢ºèªæŒ‰éˆ• */
        .btn-budget { 
            background: var(--btn-budget-bg) !important; 
            color: var(--btn-budget-text) !important;
            margin-top: 10px; 
            box-shadow: 0 4px 10px rgba(102, 184, 219, 0.4) !important;
        }
        .btn-budget:active {
            background: var(--btn-budget-active-bg) !important;
            color: var(--btn-budget-active-text) !important;
        }

        .info-box { background: #fff; border: 1px solid #eee; padding: 14px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .info-value { font-size: 18px; font-weight: bold; color: var(--text-main); }

        /* åº•éƒ¨ Tab */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); z-index: 100; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; color: #ccc; cursor: pointer; width: 33.3%; transition: color 0.3s; }
        .tab-item.active { color: var(--icon-color); font-weight: bold; }
        .tab-item i { font-size: 20px; margin-bottom: 4px; }

        /* åˆ†æåœ–è¡¨ */
        #chart_3d { width: 100%; height: 300px; margin-top: 10px; }
        .progress-container { background: #eee; border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1); }
        #progress-bar { background: var(--cat-active-bg); height: 100%; width: 0%; transition: 1s; }

        /* 8. éŒ¢åŒ… - æ¶ˆè²»ç´€éŒ„å€å¡Š */
        .history-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #eee;
        }
        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .history-btn {
            flex: 1;
            padding: 8px 0;
            font-size: 13px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-btn.active {
            background: var(--icon-color);
            color: #fff;
            border-color: var(--icon-color);
        }
        .custom-date-range {
            display: none;
            gap: 5px;
            margin-bottom: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
        }
        .table-container {
            height: 250px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto; /* å¯æ²å‹• */
            background: #fff;
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            display: none; /* é è¨­éš±è—ï¼ŒæŒ‰éˆ•æŒ‰ä¸‹æ‰é¡¯ç¤º */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th {
            background: #f0f0f0;
            position: sticky;
            top: 0;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            color: #666;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            color: var(--text-main);
        }
        .amt-col { text-align: right; font-weight: bold; color: #d8c1ec; }
        .date-col { font-size: 12px; color: #999; width: 80px; }

        /* Modal */
        #pwd-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
    </style>
</head>
<body>

    <header>
        <h2><i class="fa-solid fa-piggy-bank"></i> ç†è²¡ç´€éŒ„</h2>
    </header>

    <div class="main-container">
        <div class="card">
            <div id="page-input" class="tab-content active">
                <div class="form-group">
                    <label><i class="fa-regular fa-calendar"></i> æ—¥æœŸ</label>
                    <input type="date" id="date">
                </div>
                
                <div class="form-group">
                    <label><i class="fa-solid fa-tags"></i> ä¸»é¡åˆ¥</label>
                    <div class="category-grid" id="main-cat-grid">
                        </div>
                </div>
                
                <div class="form-group" id="sub-category-container">
                    <label><i class="fa-solid fa-filter"></i> å­é …ç›®</label>
                    <select id="sub-category"></select>
                </div>
                
                <div class="form-group">
                    <label><i class="fa-solid fa-dollar-sign"></i> æ¶ˆè²»é‡‘é¡</label>
                    <input type="number" id="amount" placeholder="0" inputmode="decimal">
                </div>
                
                <div class="form-group">
                    <label><i class="fa-solid fa-pen"></i> å‚™è¨»</label>
                    <input type="text" id="note" placeholder="é¸å¡«...">
                </div>
                
                <button id="submitBtn" class="main-btn" onclick="prepareSubmit('expense')">ç¢ºèªé€å‡º</button>
            </div>

            <div id="page-budget" class="tab-content">
                <div class="form-group">
                    <label><i class="fa-solid fa-wallet"></i> æ¯æœˆå›ºå®šé ç®—</label>
                    <input type="number" id="input_starting" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
                    <button class="main-btn btn-budget" onclick="prepareSubmit('budget')">é ç®—é‡‘é¡ç¢ºèª</button>
                </div>
                
                <div class="dashboard" style="margin-top:20px;">
                    <div class="info-box">
                        <span style="font-size:14px; color:#666;"><i class="fa-solid fa-coins"></i> ç•¶æœˆå‰©é¤˜</span>
                        <span class="info-value" id="disp_monthly_rem">0</span>
                    </div>
                    <div class="info-box" style="background: #fafafa;">
                        <span style="font-size:14px; color:#888;"><i class="fa-solid fa-chart-line"></i> ç•¶æœˆå·²èŠ±è²»</span>
                        <span class="info-value" id="disp_monthly_spent" style="color:#888;">0</span>
                    </div>
                </div>

                <div class="history-section">
                    <label><i class="fa-solid fa-list-ul"></i> æ¶ˆè²»ç´€éŒ„</label>
                    
                    <div class="history-controls">
                        <button class="history-btn" onclick="loadHistory('month', this)">ç•¶æœˆ</button>
                        <button class="history-btn" onclick="loadHistory('half', this)">åŠå¹´</button>
                        <button class="history-btn" onclick="toggleCustomDate(this)">è‡ªé¸æ™‚é–“</button>
                    </div>

                    <div id="custom-date-box" class="custom-date-range">
                        <input type="date" id="hist-start">
                        <input type="date" id="hist-end">
                        <button class="history-btn active" style="flex:0 0 50px;" onclick="loadHistory('custom', null)">GO</button>
                    </div>

                    <div id="history-table-container" class="table-container">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>å­é …ç›®</th>
                                    <th style="text-align:right;">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody id="history-list-body">
                                </tbody>
                        </table>
                        <div id="hist-loading" style="text-align:center; padding:20px; color:#999; display:none;">è¼‰å…¥ä¸­...</div>
                        <div id="hist-empty" style="text-align:center; padding:20px; color:#ccc; display:none;">æŸ¥ç„¡è³‡æ–™</div>
                    </div>
                </div>
            </div>

            <div id="page-analysis" class="tab-content">
                <label><i class="fa-solid fa-chart-pie"></i> æœ¬æœˆæ¶ˆè²»æ¯”ä¾‹</label>
                <div id="chart_3d"></div>
                
                <label><i class="fa-solid fa-fire"></i> é ç®—ä½¿ç”¨é€²åº¦</label>
                <div class="progress-container"><div id="progress-bar"></div></div>
                <p id="progress-text" style="font-size: 12px; color: var(--text-sub); text-align: right;">0%</p>
            </div>

            <div id="status" style="text-align: center; font-size: 11px; color: gray; margin-top: 15px;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('page-input', this)">
            <i class="fa-solid fa-pen-to-square"></i><span>æ¶ˆè²»</span>
        </div>
        <div class="tab-item" onclick="switchTab('page-budget', this)">
            <i class="fa-solid fa-wallet"></i><span>éŒ¢åŒ…</span>
        </div>
        <div class="tab-item" onclick="switchTab('page-analysis', this)">
            <i class="fa-solid fa-chart-simple"></i><span>åˆ†æ</span>
        </div>
    </nav>

    <div id="pwd-modal">
        <div class="modal-content">
            <label style="justify-content:center;"><i class="fa-solid fa-lock"></i> æ•¸ä½å¯†ç¢¼é©—è­‰</label>
            <input type="password" id="pwd-input" inputmode="numeric" pattern="[0-9]*" placeholder="****" style="text-align:center; letter-spacing: 5px; margin-bottom: 15px;">
            <button class="main-btn btn-budget" onclick="verifyAndAction()">ç¢ºå®š</button>
            <button class="main-btn" style="background: #e0e0e0; color:#666; margin-top:10px; box-shadow:none;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- è¨­å®š Supabase ---
        const SUPABASE_URL = 'https://sprrurptghjkxvwstukn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcnJ1cnB0Z2hqa3h2d3N0dWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjcyOTMsImV4cCI6MjA4NDU0MzI5M30.IoOY-gdM7qXPEm3DildpEOq_e3jpTfQLa19X7G6iImw';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- å­åˆ†é¡è³‡æ–™ ---
        const subData = {
            "é£Ÿ": ["æ—©é¤", "ä¸­é¤", "æ™šé¤", "é»å¿ƒ", "èœéŒ¢"],
            "è¡£": ["ä¸Šè¡£", "è¤²å­", "å…§è¡£", "å…§è¤²", "è¥ªå­", "é…ä»¶"],
            "ä½": ["æ‰‹æ©Ÿè²»", "ç¶²è·¯è²»", "é›»è²»", "æ°´è²»", "ç“¦æ–¯è²»", "ç§Ÿè»Šä½è²»", "ç®¡ç†è²»", "ç¨…è²»"],
            "è¡Œ": ["æ²¹éŒ¢", "åœè»Šè²»", "ä½å®¿è²»", "ç§Ÿè»Šè²»", "äº¤é€šè²»", "ä¿®è»Šè²»"],
            "è‚²": ["å­¸è²»", "æ›¸è²»", "æ•™è‚²è²»", "AIè²»"],
            "æ¨‚": ["å¨›æ¨‚è²»", "é›»è¦–è²»"],
            "é‡‘": ["å­˜æ¬¾", "è‚¡ç¥¨", "è™›æ“¬å¹£"],
            "é›œ": ["ä¿éšªè²»", "å…¶ä»–"]
        };

        let currentMainCat = "";
        let pendingAction = "";
        let dashboardData = { budget: 0, spent: 0, breakdown: {} };

        google.charts.load('current', {'packages':['corechart']});

        window.onload = function() {
            document.getElementById('date').valueAsDate = new Date();
            initMainCategoryGrid();
            loadDashboard();
        };

        function initMainCategoryGrid() {
            const grid = document.getElementById('main-cat-grid');
            Object.keys(subData).forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'cat-btn';
                btn.innerText = cat;
                btn.onclick = () => selectMainCat(cat, btn);
                grid.appendChild(btn);
            });
        }

        function switchTab(pageId, element) {
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            element.classList.add('active');
            if(pageId === 'page-analysis') draw3DPieChart();
        }

        // --- 8. æ¶ˆè²»ç´€éŒ„æŸ¥è©¢é‚è¼¯ ---
        function toggleCustomDate(btn) {
            // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.history-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // é¡¯ç¤ºè‡ªé¸å€å¡Š
            document.getElementById('custom-date-box').style.display = 'flex';
            // éš±è—è¡¨æ ¼ç›´åˆ°æŒ‰ä¸‹GO
            document.getElementById('history-table-container').style.display = 'none';
        }

        async function loadHistory(mode, btn) {
            // UI è™•ç†
            if(mode !== 'custom') {
                document.getElementById('custom-date-box').style.display = 'none';
                document.querySelectorAll('.history-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
            }

            const tableContainer = document.getElementById('history-table-container');
            const tbody = document.getElementById('history-list-body');
            const loading = document.getElementById('hist-loading');
            const empty = document.getElementById('hist-empty');

            // é¡¯ç¤ºè¡¨æ ¼å€å¡Šèˆ‡ Loading
            tableContainer.style.display = 'block';
            tbody.innerHTML = '';
            loading.style.display = 'block';
            empty.style.display = 'none';

            // è¨ˆç®—æ™‚é–“ç¯„åœ
            let startDate, endDate;
            const now = new Date();
            
            if (mode === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();
            } else if (mode === 'half') {
                const halfYearAgo = new Date();
                halfYearAgo.setMonth(now.getMonth() - 6);
                startDate = halfYearAgo.toISOString();
                endDate = now.toISOString();
            } else if (mode === 'custom') {
                const s = document.getElementById('hist-start').value;
                const e = document.getElementById('hist-end').value;
                if(!s || !e) {
                    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
                    loading.style.display = 'none';
                    return;
                }
                startDate = new Date(s).toISOString();
                endDate = new Date(e).toISOString(); // ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡ä¸è£œæ™‚é–“ï¼ŒSupabase date é¡å‹æ¯”å°å³å¯
            }

            // æŸ¥è©¢ Supabase
            try {
                const { data: records, error } = await _supabase
                    .from('expenses')
                    .select('*')
                    .gte('date', startDate.split('T')[0]) // ç¢ºä¿æ ¼å¼ç¬¦åˆ date æ¬„ä½
                    .lte('date', endDate.split('T')[0])
                    .order('date', { ascending: false });

                loading.style.display = 'none';

                if (error) throw error;
                if (!records || records.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                // æ¸²æŸ“è¡¨æ ¼
                records.forEach(r => {
                    const row = document.createElement('tr');
                    // æ ¼å¼åŒ–æ—¥æœŸ MM/DD
                    const d = new Date(r.date);
                    const dateStr = (d.getMonth() + 1) + '/' + d.getDate();
                    
                    row.innerHTML = `
                        <td class="date-col">${dateStr}</td>
                        <td>
                            <div style="font-weight:bold; font-size:13px;">${r.subcategory}</div>
                            <div style="font-size:11px; color:#ccc;">${r.category}</div>
                        </td>
                        <td class="amt-col">$${r.amount}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                loading.style.display = 'none';
                empty.innerText = "è®€å–å¤±æ•—";
                empty.style.display = 'block';
            }
        }

        // --- åŸæœ‰é‚è¼¯ ---
        async function loadDashboard() {
            document.getElementById('status').innerText = "ğŸ”„ åŒæ­¥ä¸­...";
            try {
                const { data: configData } = await _supabase.from('config').select('value').eq('key', 'monthly_budget').single();
                const budget = configData ? configData.value : 0;

                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();

                const { data: expenses } = await _supabase.from('expenses')
                    .select('*')
                    .gte('date', firstDay)
                    .lte('date', lastDay);

                let totalSpent = 0;
                let breakdown = {};
                expenses.forEach(e => {
                    totalSpent += parseFloat(e.amount);
                    breakdown[e.category] = (breakdown[e.category] || 0) + parseFloat(e.amount);
                });

                dashboardData = { budget, spent: totalSpent, breakdown };

                document.getElementById('input_starting').value = budget;
                document.getElementById('disp_monthly_rem').innerText = (budget - totalSpent).toLocaleString();
                document.getElementById('disp_monthly_spent').innerText = totalSpent.toLocaleString();
                updateProgressBar();
                document.getElementById('status').innerText = "â˜ï¸ é›²ç«¯åŒæ­¥å®Œæˆ";
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = "âš ï¸ åŒæ­¥å¤±æ•—";
            }
        }

        function updateProgressBar() {
            const percent = Math.min((dashboardData.spent / dashboardData.budget) * 100, 100) || 0;
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-text').innerText = Math.round(percent) + "% (å·²ç”¨ " + dashboardData.spent.toLocaleString() + ")";
        }

        function draw3DPieChart() {
            if(!dashboardData.breakdown) return;
            var dataArray = [['Category', 'Amount']];
            for (var cat in dashboardData.breakdown) {
                dataArray.push([cat, dashboardData.breakdown[cat]]);
            }
            if(dashboardData.budget > dashboardData.spent) {
                dataArray.push(['å‰©é¤˜é ç®—', dashboardData.budget - dashboardData.spent]);
            }

            var data = google.visualization.arrayToDataTable(dataArray);
            var options = {
                is3D: true,
                backgroundColor: 'transparent',
                chartArea: {width: '100%', height: '80%'},
                legend: {position: 'right', textStyle: {fontSize: 12}},
                colors: ['#8e9aaf', '#cbc0ad', '#a3b18a', '#bfa58a', '#d4a373', '#e9edc9', '#faedcd', '#ccd5ae', '#f4f1ea']
            };
            var chart = new google.visualization.PieChart(document.getElementById('chart_3d'));
            chart.draw(data, options);
        }

        function prepareSubmit(action) { 
            pendingAction = action; 
            document.getElementById('pwd-modal').style.display = 'flex'; 
            document.getElementById('pwd-input').focus(); 
        }

        function closeModal() { 
            document.getElementById('pwd-modal').style.display = 'none'; 
            document.getElementById('pwd-input').value = ""; 
        }

        function verifyAndAction() {
            if (document.getElementById('pwd-input').value === "0728") {
                closeModal();
                if (pendingAction === 'expense') executeSubmit();
                else executeUpdateBudget();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        }

        function selectMainCat(cat, btnElement) {
            currentMainCat = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            const container = document.getElementById('sub-category-container');
            const select = document.getElementById('sub-category');
            select.innerHTML = "";
            subData[currentMainCat].forEach(item => {
                let opt = document.createElement('option');
                opt.value = item; opt.innerText = item; select.appendChild(opt);
            });
            container.style.display = "block";
        }

        async function executeUpdateBudget() {
            const val = document.getElementById('input_starting').value;
            const { error } = await _supabase.from('config').upsert({ key: 'monthly_budget', value: val });
            if(error) alert("æ›´æ–°å¤±æ•—");
            loadDashboard();
        }

        async function executeSubmit() {
            const amt = document.getElementById('amount').value;
            if(!amt || !currentMainCat) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const { error } = await _supabase.from('expenses').insert([{
                date: document.getElementById('date').value,
                category: currentMainCat,
                subcategory: document.getElementById('sub-category').value,
                amount: parseFloat(amt),
                note: document.getElementById('note').value
            }]);

            if(!error) {
                alert("ç´€éŒ„æˆåŠŸ");
                document.getElementById('amount').value = "";
                document.getElementById('note').value = "";
                loadDashboard();
            } else {
                alert("ç´€éŒ„å¤±æ•—: " + error.message);
            }
        }
    </script>
</body>
</html>
