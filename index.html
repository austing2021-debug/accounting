<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦ ç†è²¡ç´€éŒ„ (Smart CSV)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-color: #fbf9f4;
            --input-bg: #ededed;
            --card-bg: #ffffff;
            --icon-color: #454545;
            --text-main: #000000;
            --text-sub: #8d8d8d;
            
            --cat-default-bg: #ecf6fd; 
            --cat-default-text: #454545;
            --cat-active-bg: #66b8db;
            --cat-active-text: #fbf9f4;

            --btn-submit-bg: #66b8db;
            --btn-submit-text: #fbf9f4;
            --btn-submit-active-bg: #ecf6fd;
            --btn-submit-active-text: #454545;
            
            --delete-color: #ff4d4f;
            --import-color: #20c997;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; 
        }

        header { padding: 15px; text-align: center; background: var(--bg-color); }
        h2 { margin: 0; color: var(--icon-color); font-size: 1.3rem; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .main-container { flex: 1; padding: 15px; padding-bottom: 80px; display: flex; justify-content: center; overflow-y: auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); width: 100%; max-width: 400px; box-sizing: border-box; min-height: fit-content; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-group { margin-bottom: 15px; }
        label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--icon-color); font-size: 14px; font-weight: bold; }
        
        input, select { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            box-sizing: border-box; font-size: 16px; background: var(--input-bg); 
            color: var(--text-main); outline: none; -webkit-appearance: none;
            box-shadow: inset 2px 2px 6px rgba(0,0,0,0.1), inset -2px -2px 6px rgba(255,255,255,0.7);
            transition: all 0.2s;
        }
        input:focus, select:focus { box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15); }

        .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cat-btn { 
            padding: 12px 0; background: var(--cat-default-bg); color: var(--cat-default-text);
            border: none; border-radius: 15px; font-size: 14px; font-weight: bold;
            cursor: pointer; text-align: center; 
            box-shadow: 3px 3px 6px rgba(0,0,0,0.1), -1px -1px 4px rgba(255,255,255,0.8);
            transition: all 0.2s ease;
        }
        .cat-btn.active { background: var(--cat-active-bg); color: var(--cat-active-text); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); }

        #sub-category-container { display: none; background: transparent; margin-bottom: 15px; }

        button.main-btn { 
            width: 100%; padding: 16px; background: var(--btn-submit-bg); color: var(--btn-submit-text); 
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(102, 184, 219, 0.4); transition: all 0.2s;
        }
        button.main-btn:active {
            background: var(--btn-submit-active-bg); color: var(--btn-submit-active-text);
            transform: translateY(2px); box-shadow: none;
        }

        .btn-budget { margin-top: 10px; }

        .info-box { background: #fff; border: 1px solid #eee; padding: 14px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .info-value { font-size: 18px; font-weight: bold; color: var(--text-main); }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); z-index: 100; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; color: #ccc; cursor: pointer; width: 33.3%; transition: color 0.3s; }
        .tab-item.active { color: var(--icon-color); font-weight: bold; }
        .tab-item i { font-size: 20px; margin-bottom: 4px; }

        #chart-container { position: relative; width: 100%; height: 300px; margin-top: 10px; display: flex; justify-content: center; }
        #chart_donut { width: 100%; height: 100%; }
        #center-text { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; display: none; z-index: 10; }
        #center-label { font-size: 14px; color: #888; display: block; }
        #center-value { font-size: 22px; font-weight: bold; color: var(--text-main); display: block; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        #trend_chart_div { width: 100%; height: 250px; margin-top: 15px; }

        .progress-container { background: #eee; border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1); }
        #progress-bar { background: var(--cat-active-bg); height: 100%; width: 0%; transition: 1s; }

        .history-section { margin-top: 25px; padding-top: 20px; border-top: 2px dashed #eee; }
        .history-controls { display: flex; gap: 5px; margin-bottom: 15px; justify-content: space-between; }
        .history-btn {
            flex: 1; padding: 8px 0; font-size: 12px; background: #fff;
            border: 1px solid #ddd; border-radius: 8px; color: var(--text-main);
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .history-btn.active { background: var(--icon-color); color: #fff; border-color: var(--icon-color); }
        
        .custom-date-range { display: none; gap: 5px; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        
        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        .table-container {
            height: 300px; overflow-y: auto; background: #fff;
            border-radius: 12px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            border: 1px solid #eee; display: none; position: relative;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f0f0f0; position: sticky; top: 0; padding: 10px; text-align: left; font-size: 12px; color: #666; z-index: 5;}
        td { padding: 8px 10px; border-bottom: 1px solid #f5f5f5; color: var(--text-main); vertical-align: middle; }
        
        .amt-col { text-align: right; font-weight: bold; width: 70px; }
        .date-col { font-size: 12px; color: #999; width: 50px; }
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .cat-select {
            border: 1px solid #eee; background: #fbfbfb; border-radius: 6px;
            padding: 4px; font-size: 13px; color: #454545; width: 100%;
            cursor: pointer; outline: none; box-shadow: none;
        }
        .cat-select:focus { border-color: var(--btn-submit-bg); background: #fff; }

        .checkbox-col { width: 35px; text-align: center; display: none; }
        .delete-mode .checkbox-col { display: table-cell; }
        
        .row-checkbox {
            appearance: none; -webkit-appearance: none; width: 22px; height: 22px;
            border: 2px solid #ddd; border-radius: 50%; cursor: pointer;
            position: relative; transition: all 0.2s; background: #fff; vertical-align: middle;
        }
        .row-checkbox:checked { background-color: var(--delete-color); border-color: var(--delete-color); }
        .row-checkbox:checked::after {
            content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px;
        }

        .table-footer-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .action-btn { padding: 8px 15px; border-radius: 8px; font-size: 13px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-delete { background: #fff; border: 1px solid var(--delete-color); color: var(--delete-color); }
        .btn-confirm-del { background: var(--delete-color); color: white; display: none; }

        .import-section {
            margin-top: 25px; padding: 20px; border: 2px dashed #ddd;
            border-radius: 12px; text-align: center; background: #fafafa;
        }
        .btn-import { background: var(--import-color); color: white; width: auto; display: inline-block; margin-top: 10px; }
        .btn-import:active { background: #17a57a; }

    </style>
</head>
<body>

    <header><h2><i class="fa-solid fa-piggy-bank"></i> ç†è²¡ç´€éŒ„</h2></header>

    <div class="main-container">
        <div class="card">
            <div id="page-input" class="tab-content active">
                <div class="form-group">
                    <label><i class="fa-regular fa-calendar"></i> æ—¥æœŸ</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-tags"></i> ä¸»é¡åˆ¥</label>
                    <div class="category-grid" id="main-cat-grid"></div>
                </div>
                <div class="form-group" id="sub-category-container">
                    <label><i class="fa-solid fa-filter"></i> å­é …ç›®</label>
                    <select id="sub-category"></select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-dollar-sign"></i> æ¶ˆè²»é‡‘é¡</label>
                    <input type="number" id="amount" placeholder="0" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-pen"></i> å‚™è¨»</label>
                    <input type="text" id="note" placeholder="é¸å¡«...">
                </div>
                <button id="submitBtn" class="main-btn" onclick="executeSubmit()">ç¢ºèªé€å‡º</button>
            </div>

            <div id="page-budget" class="tab-content">
                <div class="form-group">
                    <label><i class="fa-solid fa-wallet"></i> æ¯æœˆå›ºå®šé ç®—</label>
                    <input type="number" id="input_starting" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
                    <button class="main-btn btn-budget" onclick="executeUpdateBudget()">é ç®—é‡‘é¡ç¢ºèª</button>
                </div>
                
                <div class="dashboard" style="margin-top:20px;">
                    <div class="info-box">
                        <span style="font-size:14px; color:#666;"><i class="fa-solid fa-coins"></i> ç•¶æœˆå‰©é¤˜</span>
                        <span class="info-value" id="disp_monthly_rem">0</span>
                    </div>
                    <div class="info-box" style="background: #fafafa;">
                        <span style="font-size:14px; color:#888;"><i class="fa-solid fa-chart-line"></i> ç•¶æœˆå·²èŠ±è²»</span>
                        <span class="info-value" id="disp_monthly_spent" style="color:#888;">0</span>
                    </div>
                </div>

                <div class="history-section">
                    <label><i class="fa-solid fa-list-ul"></i> æ¶ˆè²»ç´€éŒ„</label>
                    
                    <div class="history-controls">
                        <button class="history-btn" onclick="loadHistory('month', this)">ç•¶æœˆ</button>
                        <button class="history-btn" onclick="loadHistory('half', this)">åŠå¹´</button>
                        <button class="history-btn" onclick="toggleCustomDate(this)">è‡ªé¸æ™‚é–“</button>
                    </div>

                    <div id="custom-date-box" class="custom-date-range">
                        <input type="date" id="hist-start">
                        <input type="date" id="hist-end">
                        <button class="history-btn active" style="flex:0 0 50px;" onclick="loadHistory('custom', null)">GO</button>
                    </div>

                    <div id="history-table-container" class="table-container">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-col"><i class="fa-solid fa-trash-can"></i></th>
                                    <th>æ™‚é–“</th>
                                    <th>ä¸»åˆ†é¡</th> <th>å­é …ç›®</th>
                                    <th style="text-align:right;">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody id="history-list-body"></tbody>
                        </table>
                        <div id="hist-loading" style="text-align:center; padding:20px; color:#999; display:none;">è¼‰å…¥ä¸­...</div>
                        <div id="hist-empty" style="text-align:center; padding:20px; color:#ccc; display:none;">æŸ¥ç„¡è³‡æ–™</div>
                    </div>
                    
                    <div class="table-footer-actions" id="table-actions" style="display:none;">
                        <button id="btn-delete" class="action-btn btn-delete" onclick="toggleDeleteMode()">åˆªé™¤</button>
                        <button id="btn-confirm-del" class="action-btn btn-confirm-del" onclick="executeDelete()">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>

                <div class="import-section">
                    <label style="justify-content: center; color:#666;"><i class="fa-solid fa-file-csv"></i> æ™ºæ…§ç™¼ç¥¨åŒ¯å…¥</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 10px; line-height: 1.5;">
                        æ”¯æ´æ ¼å¼ï¼š<br>
                        1. è²¡æ”¿éƒ¨ CSV (è‡ªå‹•è¾¨è­˜æ¨™é¡Œ)<br>
                        2. ç°¡æ˜“ CSV (æ—¥æœŸ, é‡‘é¡, å‚™è¨»)<br>
                        (é è¨­æ­¸é¡ç‚ºã€Œé›œ-å…¶ä»–ã€)
                    </div>
                    <input type="file" id="csvInput" accept=".csv" style="display:none;" onchange="handleCSVUpload(this)">
                    <button class="main-btn btn-import" onclick="document.getElementById('csvInput').click()">
                        <i class="fa-solid fa-folder-open"></i> é¸æ“‡ CSV æª”æ¡ˆ
                    </button>
                    <div id="import-status" style="font-size: 12px; color: #20c997; margin-top: 5px;"></div>
                </div>
            </div>

            <div id="page-analysis" class="tab-content">
                <label><i class="fa-solid fa-chart-pie"></i> æœ¬æœˆæ¶ˆè²»æ¯”ä¾‹</label>
                <div id="chart-container">
                    <div id="chart_donut"></div>
                    <div id="center-text"><span id="center-label">ç¸½è¨ˆ</span><span id="center-value">$0</span></div>
                </div>
                <label style="margin-top:20px;"><i class="fa-solid fa-chart-line"></i> å¹´åº¦èŠ±è²»è¶¨å‹¢</label>
                <div id="trend_chart_div"></div>
                <label style="margin-top:20px;"><i class="fa-solid fa-fire"></i> é ç®—ä½¿ç”¨é€²åº¦</label>
                <div class="progress-container"><div id="progress-bar"></div></div>
                <p id="progress-text" style="font-size: 12px; color: var(--text-sub); text-align: right;">0%</p>
            </div>

            <div id="status" style="text-align: center; font-size: 11px; color: gray; margin-top: 15px;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('page-input', this)">
            <i class="fa-solid fa-pen-to-square"></i><span>æ¶ˆè²»</span>
        </div>
        <div class="tab-item" onclick="switchTab('page-budget', this)">
            <i class="fa-solid fa-wallet"></i><span>éŒ¢åŒ…</span>
        </div>
        <div class="tab-item" onclick="switchTab('page-analysis', this)">
            <i class="fa-solid fa-chart-simple"></i><span>åˆ†æ</span>
        </div>
    </nav>

    <script>
        const SUPABASE_URL = 'https://sprrurptghjkxvwstukn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcnJ1cnB0Z2hqa3h2d3N0dWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjcyOTMsImV4cCI6MjA4NDU0MzI5M30.IoOY-gdM7qXPEm3DildpEOq_e3jpTfQLa19X7G6iImw';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const subData = {
            "é£Ÿ": ["æ—©é¤", "ä¸­é¤", "æ™šé¤", "é»å¿ƒ", "èœéŒ¢"],
            "è¡£": ["ä¸Šè¡£", "è¤²å­", "å…§è¡£", "å…§è¤²", "è¥ªå­", "é…ä»¶"],
            "ä½": ["æ‰‹æ©Ÿè²»", "ç¶²è·¯è²»", "é›»è²»", "æ°´è²»", "ç“¦æ–¯è²»", "ç§Ÿè»Šä½è²»", "ç®¡ç†è²»", "ç¨…è²»"],
            "è¡Œ": ["æ²¹éŒ¢", "åœè»Šè²»", "ä½å®¿è²»", "ç§Ÿè»Šè²»", "äº¤é€šè²»", "ä¿®è»Šè²»"],
            "è‚²": ["å­¸è²»", "æ›¸è²»", "æ•™è‚²è²»", "AIè²»"],
            "æ¨‚": ["å¨›æ¨‚è²»", "é›»è¦–è²»"],
            "é‡‘": ["å­˜æ¬¾", "è‚¡ç¥¨", "è™›æ“¬å¹£"],
            "é›œ": ["ä¿éšªè²»", "å…¶ä»–"]
        };

        let currentMainCat = "";
        let dashboardData = { budget: 0, spent: 0, breakdown: {} };
        let donutChart;
        let isDeleteMode = false;

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(initChartWrapper);
        function initChartWrapper() { }

        window.onload = function() {
            document.getElementById('date').valueAsDate = new Date();
            initMainCategoryGrid();
            loadDashboard();
        };

        function initMainCategoryGrid() {
            const grid = document.getElementById('main-cat-grid');
            Object.keys(subData).forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'cat-btn';
                btn.innerText = cat;
                btn.onclick = () => selectMainCat(cat, btn);
                grid.appendChild(btn);
            });
        }

        function switchTab(pageId, element) {
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            element.classList.add('active');
            if(pageId === 'page-analysis') { drawDonutChart(); drawTrendChart(); }
            if(isDeleteMode) toggleDeleteMode();
        }

        // --- æ ¸å¿ƒæ›´æ–°åŠŸèƒ½ï¼šä¿®æ”¹åˆ†é¡ ---
        async function updateCategory(id, newCat) {
            const { error } = await _supabase.from('expenses').update({ category: newCat }).eq('id', id);
            if(error) {
                alert("ä¿®æ”¹å¤±æ•—");
            } else {
                // ä¿®æ”¹æˆåŠŸå¾Œï¼Œçµ¦äºˆä¸€é»è¦–è¦ºå›é¥‹ (å¯é¸)
                loadDashboard(); // é‡æ–°è¨ˆç®—é‡‘é¡èˆ‡åœ–è¡¨
            }
        }

        // --- åˆªé™¤åŠŸèƒ½ ---
        function toggleDeleteMode() {
            isDeleteMode = !isDeleteMode;
            const table = document.getElementById('history-table');
            const btnDel = document.getElementById('btn-delete');
            const btnConfirm = document.getElementById('btn-confirm-del');
            if(isDeleteMode) {
                table.classList.add('delete-mode');
                btnDel.style.display = 'none'; btnConfirm.style.display = 'inline-block';
            } else {
                table.classList.remove('delete-mode');
                btnDel.style.display = 'inline-block'; btnConfirm.style.display = 'none';
                document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
            }
        }

        async function executeDelete() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if(checkboxes.length === 0) { alert("è«‹å‹¾é¸é …ç›®"); return; }
            if(!confirm(`ç¢ºå®šåˆªé™¤ ${checkboxes.length} ç­†ï¼Ÿ`)) return;
            const idsToDelete = Array.from(checkboxes).map(cb => cb.value);
            const { error } = await _supabase.from('expenses').delete().in('id', idsToDelete);
            if(error) alert("åˆªé™¤å¤±æ•—");
            else { alert("åˆªé™¤æˆåŠŸ"); toggleDeleteMode(); refreshCurrentHistory(); loadDashboard(); }
        }

        function refreshCurrentHistory() {
            const activeBtn = document.querySelector('.history-btn.active');
            if(activeBtn && activeBtn.innerText === 'ç•¶æœˆ') loadHistory('month', activeBtn);
            else if(activeBtn && activeBtn.innerText === 'åŠå¹´') loadHistory('half', activeBtn);
            else if(activeBtn && activeBtn.innerText === 'GO') loadHistory('custom', null);
        }

        // --- æ­·å²ç´€éŒ„ (å«ä¸‹æ‹‰é¸å–®ç”Ÿæˆ) ---
        function toggleCustomDate(btn) {
            document.querySelectorAll('.history-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.getElementById('custom-date-box').style.display = 'flex';
            document.getElementById('history-table-container').style.display = 'none';
            document.getElementById('table-actions').style.display = 'none';
        }

        async function loadHistory(mode, btn) {
            if(mode !== 'custom') {
                document.getElementById('custom-date-box').style.display = 'none';
                document.querySelectorAll('.history-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
            }
            const tableContainer = document.getElementById('history-table-container');
            const tbody = document.getElementById('history-list-body');
            const loading = document.getElementById('hist-loading');
            const empty = document.getElementById('hist-empty');
            const actions = document.getElementById('table-actions');

            if(isDeleteMode) toggleDeleteMode();
            tableContainer.style.display = 'block'; tbody.innerHTML = '';
            loading.style.display = 'block'; empty.style.display = 'none'; actions.style.display = 'none';

            let startDate, endDate;
            const now = new Date();
            if (mode === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();
            } else if (mode === 'half') {
                startDate = new Date(now.setMonth(now.getMonth() - 6)).toISOString();
                endDate = new Date().toISOString();
            } else if (mode === 'custom') {
                const s = document.getElementById('hist-start').value;
                const e = document.getElementById('hist-end').value;
                if(!s || !e) { alert("è«‹é¸æ“‡æ—¥æœŸ"); loading.style.display = 'none'; return; }
                startDate = new Date(s).toISOString(); endDate = new Date(e).toISOString();
            }

            const { data: records, error } = await _supabase.from('expenses')
                .select('*').gte('date', startDate.split('T')[0]).lte('date', endDate.split('T')[0])
                .order('date', { ascending: false });

            loading.style.display = 'none';
            if (!records || records.length === 0) { empty.style.display = 'block'; return; }
            actions.style.display = 'flex';

            records.forEach(r => {
                const row = document.createElement('tr');
                const d = new Date(r.date);
                const dateStr = (d.getMonth() + 1) + '/' + d.getDate();
                
                const amt = parseFloat(r.amount);
                let color = '#454545';
                if (amt >= 10000) color = '#d600a8'; else if (amt >= 1000) color = '#ff0000'; else if (amt >= 100) color = '#f891b5';

                // ç”Ÿæˆä¸»åˆ†é¡ä¸‹æ‹‰é¸å–®
                let catOptions = '';
                Object.keys(subData).forEach(cat => {
                    const selected = cat === r.category ? 'selected' : '';
                    catOptions += `<option value="${cat}" ${selected}>${cat}</option>`;
                });

                row.innerHTML = `
                    <td class="checkbox-col"><input type="checkbox" class="row-checkbox" value="${r.id}"></td>
                    <td class="date-col">${dateStr}</td>
                    <td>
                        <select class="cat-select" onchange="updateCategory('${r.id}', this.value)">
                            ${catOptions}
                        </select>
                    </td>
                    <td>
                        <div style="font-weight:bold; font-size:13px;">${r.subcategory}</div>
                        <div style="font-size:11px; color:#ccc;">${r.note || ''}</div>
                    </td>
                    <td class="amt-col" style="color:${color};">$${r.amount}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadDashboard() {
            // çœç•¥è¼‰å…¥å‹•ç•«ï¼Œé¿å…ä¿®æ”¹åˆ†é¡æ™‚ç•«é¢é–ƒçˆ
            const { data: configData } = await _supabase.from('config').select('value').eq('key', 'monthly_budget').single();
            const budget = configData ? configData.value : 0;
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();
            const { data: expenses } = await _supabase.from('expenses').select('*').gte('date', firstDay).lte('date', lastDay);

            let totalSpent = 0; let breakdown = {};
            expenses.forEach(e => {
                totalSpent += parseFloat(e.amount);
                breakdown[e.category] = (breakdown[e.category] || 0) + parseFloat(e.amount);
            });
            dashboardData = { budget, spent: totalSpent, breakdown };

            document.getElementById('input_starting').value = budget;
            document.getElementById('disp_monthly_rem').innerText = (budget - totalSpent).toLocaleString();
            document.getElementById('disp_monthly_spent').innerText = totalSpent.toLocaleString();
            updateProgressBar();
            document.getElementById('status').innerText = "â˜ï¸";
        }

        function updateProgressBar() {
            const percent = Math.min((dashboardData.spent / dashboardData.budget) * 100, 100) || 0;
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-text').innerText = Math.round(percent) + "% (å·²ç”¨ " + dashboardData.spent.toLocaleString() + ")";
        }

        // --- åœ–è¡¨ ---
        function drawDonutChart() {
            if(!dashboardData.breakdown) return;
            var dataArray = [['Category', 'Amount']];
            for (var cat in dashboardData.breakdown) dataArray.push([cat, dashboardData.breakdown[cat]]);
            if(dataArray.length === 1) dataArray.push(['ç„¡æ¶ˆè²»', 1]);

            var data = google.visualization.arrayToDataTable(dataArray);
            var options = {
                pieHole: 0.7, pieSliceText: 'none', backgroundColor: 'transparent',
                chartArea: {left: 'auto', top: 10, width: '100%', height: '80%'},
                legend: {position: 'bottom', maxLines: 2, textStyle: {fontSize: 12}},
                tooltip: { trigger: 'focus' },
                colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#767676']
            };
            donutChart = new google.visualization.PieChart(document.getElementById('chart_donut'));
            google.visualization.events.addListener(donutChart, 'select', function() {
                var selection = donutChart.getSelection();
                var centerText = document.getElementById('center-text');
                if (selection.length > 0) {
                    var row = selection[0].row;
                    document.getElementById('center-label').innerText = data.getValue(row, 0);
                    document.getElementById('center-value').innerText = "$" + data.getValue(row, 1).toLocaleString();
                    centerText.style.display = "block";
                } else {
                    document.getElementById('center-label').innerText = "æœ¬æœˆç¸½è¨ˆ";
                    document.getElementById('center-value').innerText = "$" + dashboardData.spent.toLocaleString();
                }
            });
            document.getElementById('center-label').innerText = "æœ¬æœˆç¸½è¨ˆ";
            document.getElementById('center-value').innerText = "$" + dashboardData.spent.toLocaleString();
            document.getElementById('center-text').style.display = "block";
            donutChart.draw(data, options);
        }

        async function drawTrendChart() {
            const now = new Date(); const thisYear = now.getFullYear(); const lastYear = thisYear - 1;
            const startDate = `${lastYear}-01-01`; const endDate = `${thisYear}-12-31`;
            const { data: records } = await _supabase.from('expenses').select('date, amount').gte('date', startDate).lte('date', endDate);
            if(!records) return;

            let monthlyData = {};
            for(let i=1; i<=12; i++) monthlyData[i] = { thisYear: 0, lastYear: 0 };
            records.forEach(r => {
                const d = new Date(r.date); const y = d.getFullYear(); const m = d.getMonth() + 1; const amt = parseFloat(r.amount);
                if(y === thisYear) monthlyData[m].thisYear += amt; else if(y === lastYear) monthlyData[m].lastYear += amt;
            });

            var dataArray = [['æœˆä»½', 'ä»Šå¹´èŠ±è²»', 'å»å¹´èŠ±è²»']];
            for(let i=1; i<=12; i++) dataArray.push([i + 'æœˆ', monthlyData[i].thisYear, monthlyData[i].lastYear]);

            var data = google.visualization.arrayToDataTable(dataArray);
            var options = {
                title : 'å¹´åº¦èŠ±è²»å°æ¯”', vAxis: {title: 'é‡‘é¡ ($)'}, hAxis: {title: 'æœˆä»½'},
                seriesType: 'bars', series: {1: {type: 'line'}}, colors: ['#36A2EB', '#FF6384'],
                legend: { position: 'bottom' }, chartArea: {width: '80%', height: '70%'}
            };
            var chart = new google.visualization.ComboChart(document.getElementById('trend_chart_div'));
            chart.draw(data, options);
        }

        function selectMainCat(cat, btnElement) {
            currentMainCat = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            const container = document.getElementById('sub-category-container');
            const select = document.getElementById('sub-category');
            select.innerHTML = "";
            subData[currentMainCat].forEach(item => {
                let opt = document.createElement('option');
                opt.value = item; opt.innerText = item; select.appendChild(opt);
            });
            container.style.display = "block";
        }

        async function executeUpdateBudget() {
            const val = document.getElementById('input_starting').value;
            const { error } = await _supabase.from('config').upsert({ key: 'monthly_budget', value: val });
            if(error) alert("æ›´æ–°å¤±æ•—"); else { alert("é ç®—æ›´æ–°æˆåŠŸï¼"); loadDashboard(); }
        }

        async function executeSubmit() {
            const amt = document.getElementById('amount').value;
            if(!amt || !currentMainCat) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            const { error } = await _supabase.from('expenses').insert([{
                date: document.getElementById('date').value,
                category: currentMainCat,
                subcategory: document.getElementById('sub-category').value,
                amount: parseFloat(amt),
                note: document.getElementById('note').value
            }]);
            if(!error) {
                alert("ç´€éŒ„æˆåŠŸ");
                document.getElementById('amount').value = "";
                document.getElementById('note').value = "";
                currentMainCat = "";
                document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('sub-category-container').style.display = "none";
                document.getElementById('sub-category').innerHTML = "";
                loadDashboard();
            } else { alert("ç´€éŒ„å¤±æ•—: " + error.message); }
        }

        // --- æ™ºæ…§ CSV åŒ¯å…¥é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹) ---
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            document.getElementById('import-status').innerText = "è®€å–ä¸­...";
            
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n');
                
                let recordsToInsert = [];
                let errorCount = 0;

                // 1. è®€å–æ¨™é¡Œåˆ— (ç¬¬ä¸€åˆ—)
                const headerLine = rows[0].trim();
                const headers = headerLine.split(',').map(h => h.trim().replace(/"/g, '')); // å»é™¤å¼•è™Ÿ

                // 2. æ™ºæ…§åˆ¤æ–·æ¬„ä½ç´¢å¼•
                // é è¨­ç‚º 0, 1, 2 (ç°¡æ˜“æ¨¡å¼)
                let dateIdx = 0;
                let amtIdx = 1;
                let noteIdx = 2;
                let subIdx = -1; // ç”¨ä¾†å­˜å­é …ç›® (ä¾‹å¦‚å“å)

                // æœå°‹é—œéµå­—
                const targetDate = "ç™¼ç¥¨æ—¥æœŸ";
                const targetAmt = "ç™¼ç¥¨é‡‘é¡"; // æœ‰äº›æ˜¯"ç¸½é‡‘é¡"
                const targetNote = "æ¶ˆè²»æ˜ç´°_å“å"; // æˆ–è€… "å“å"

                // å¦‚æœæ¨™é¡ŒåŒ…å«é—œéµå­—ï¼Œå°±ä½¿ç”¨æ‰¾åˆ°çš„ç´¢å¼•
                if (headers.includes(targetDate)) {
                    dateIdx = headers.indexOf(targetDate);
                    // å¦‚æœæœ‰æ‰¾åˆ°ç™¼ç¥¨æ—¥æœŸï¼Œé€šå¸¸ä»£è¡¨é€™æ˜¯é›»å­ç™¼ç¥¨æ ¼å¼ï¼Œå˜—è©¦æ‰¾å…¶ä»–æ¬„ä½
                    // é‡‘é¡å¯èƒ½å« "ç™¼ç¥¨é‡‘é¡" æˆ– "ç¸½é‡‘é¡"
                    amtIdx = headers.indexOf(targetAmt);
                    if (amtIdx === -1) amtIdx = headers.indexOf("ç¸½é‡‘é¡");
                    
                    // å‚™è¨»å°æ‡‰åˆ°å“å
                    noteIdx = headers.indexOf(targetNote);
                    if (noteIdx === -1) noteIdx = headers.indexOf("å“å");
                }

                // 3. è®€å–è³‡æ–™
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if (!row) continue;
                    
                    // ç°¡æ˜“åˆ†å‰² (æœªè™•ç†æ¬„ä½å…§é€—è™Ÿï¼Œè‹¥éœ€åš´è¬¹å¯ç”¨ Regex)
                    const cols = row.split(',').map(c => c.trim().replace(/"/g, ''));
                    
                    if (cols.length > Math.max(dateIdx, amtIdx)) {
                        const dateStr = cols[dateIdx];
                        const amountStr = cols[amtIdx];
                        const noteStr = noteIdx > -1 ? cols[noteIdx] : "CSV åŒ¯å…¥";

                        const amount = parseFloat(amountStr);
                        
                        if (!isNaN(amount) && amount > 0 && dateStr.length >= 8) {
                            recordsToInsert.push({
                                date: dateStr,
                                category: 'é›œ', // é è¨­
                                subcategory: 'å…¶ä»–',
                                amount: amount,
                                note: noteStr
                            });
                        } else {
                            errorCount++;
                        }
                    }
                }

                if (recordsToInsert.length > 0) {
                    const { error } = await _supabase.from('expenses').insert(recordsToInsert);
                    if (error) {
                        alert("åŒ¯å…¥å¤±æ•—: " + error.message);
                        document.getElementById('import-status').innerText = "åŒ¯å…¥å¤±æ•—";
                    } else {
                        alert(`æˆåŠŸåŒ¯å…¥ ${recordsToInsert.length} ç­†è³‡æ–™ï¼\n(ç•¥é ${errorCount} ç­†)`);
                        document.getElementById('import-status').innerText = "";
                        loadDashboard();
                    }
                } else {
                    alert("ç„¡æœ‰æ•ˆè³‡æ–™ï¼Œè«‹ç¢ºèª CSV æ ¼å¼ã€‚\n(éœ€åŒ…å«ï¼šç™¼ç¥¨æ—¥æœŸ, ç™¼ç¥¨é‡‘é¡)");
                    document.getElementById('import-status').innerText = "æ ¼å¼éŒ¯èª¤";
                }
                input.value = ''; 
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
